{% extends "shared/base.html" %}

{% block title %}Teaching Load Overview - Admin Dashboard{% endblock %}

{% block content %}
{% set department_stats = {} %}
{% for data in teaching_data.values() %}
    {% if data.department not in department_stats %}
        {% set _ = department_stats.update({data.department: {'count': 0, 'courses': 0}}) %}
    {% endif %}
    {% set _ = department_stats[data.department].update({
        'count': department_stats[data.department]['count'] + 1,
        'courses': department_stats[data.department]['courses'] + data.current_courses
    }) %}
{% endfor %}

<div class="min-h-screen bg-gray-100 py-8 px-4 md:px-8">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="fixed bottom-4 right-4 z-50">
                {% for category, message in messages %}
                    <div class="flex items-center p-4 mb-4 rounded-lg {{ 'bg-green-100 text-green-800' if category == 'success' else 'bg-red-100 text-red-800' }}">
                        <span class="mr-2">
                            {% if category == 'success' %}
                                <svg width="32" height="32" fill="currentColor" class="bi bi-journal-bookmark text-success" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                            {% else %}
                                <svg width="32" height="32" fill="currentColor" class="bi bi-journal-bookmark text-success" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            {% endif %}
                        </span>
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Teaching Load Overview</h1>
                <p class="mt-2 text-gray-600">Current teaching assignments and workload distribution</p>
            </div>
            <a href="{{ url_for('admin.professor_list') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg width="32" height="32" fill="currentColor" class="bi bi-journal-bookmark text-success" viewBox="0 0 16 16">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to Professor List
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded shadow-sm mb-4 p-4">
        <form method="GET" class="row g-3 align-items-center">
            <div class="col-md-4">
                <label for="department" class="visually-hidden">Department</label>
                <select name="department" id="department" class="form-select">
                    <option value="">All Departments</option>
                    {% for department in department_stats.keys() %}
                        <option value="{{ department }}" {% if request.args.get('department') == department %}selected{% endif %}>{{ department }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="status" class="visually-hidden">Status</label>
                <select name="status" id="status" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>Active</option>
                    <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div class="col-md-4 text-end">
                <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
            </div>
        </form>
    </div>

    <!-- Department Summary -->
    <div class="row g-4 mb-4">
        {% for department, stats in department_stats.items() %}
            <div class="col-md-4">
                <div class="card shadow-sm h-100 border-primary">
                    <div class="card-body">
                        <h4 class="card-title text-primary mb-3">
                            <i class="bi bi-building me-2"></i>{{ department }}
                        </h4>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-info me-2"><i class="bi bi-people"></i> Professors</span>
                            <span class="fs-5 fw-bold">{{ stats.count }}</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-success me-2"><i class="bi bi-journal-bookmark"></i> Courses</span>
                            <span class="fs-5 fw-bold">{{ stats.courses }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-secondary me-2"><i class="bi bi-bar-chart"></i> Avg/Prof</span>
                            <span class="fs-6">{{ (stats.courses / stats.count)|round(2) if stats.count else 0 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Teaching Load Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="table table-striped">
                <thead class="bg-gray-50">
                    <tr>
                        <th>Professor</th>
                        <th>Email</th>
                        <th>Office</th>
                        <th>Department</th>
                        <th>Current Courses</th>
                        <th>Courses</th>
                        <th>Status</th>
                        <th>Load</th>
                    </tr>
                </thead>
                <tbody>
                    {% for professor_id, data in teaching_data.items() %}
                        {% if (not request.args.get('department') or data.department == request.args.get('department')) and (not request.args.get('status') or data.status == request.args.get('status')) %}
                        <tr {% if data.current_courses >= 5 %}class="table-warning"{% endif %}>
                            <td class="fw-medium">{{ data.name }}</td>
                            <td class="text-muted small">{{ data.email if data.email else 'N/A' }}</td>
                            <td>{{ data.office_number if data.office_number else 'N/A' }}</td>
                            <td>{{ data.department }}</td>
                            <td>{{ data.current_courses }}</td>
                            <td>
                                {% if data.courses %}
                                    {% for course in data.courses %}
                                        <span class="badge bg-info text-dark">{{ course.code }}</span>
                                    {% endfor %}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge {% if data.status == 'active' %}bg-success bg-opacity-10 text-success{% elif data.status == 'inactive' %}bg-danger bg-opacity-10 text-danger{% else %}bg-warning bg-opacity-10 text-warning{% endif %}">
                                    {{ data.status|title }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress w-75 me-2" style="height: 8px;">
                                        {% set load_percentage = (data.current_courses / 4 * 100)|round %}
                                        <div class="progress-bar {% if load_percentage >= 100 %}bg-danger{% elif load_percentage >= 75 %}bg-warning{% else %}bg-success{% endif %}" style="width: {{ load_percentage }}%"></div>
                                    </div>
                                    <span>{{ data.current_courses }} ({{ load_percentage }}%)</span>
                                    {% if data.current_courses >= 5 %}
                                        <span class="ms-2 text-danger" title="Overloaded"><i class="bi bi-exclamation-triangle-fill"></i></span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Load Distribution Chart -->
    <div class="mt-8 bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Teaching Load Distribution</h3>
        <div class="mb-3">
            <span class="badge bg-success">&lt; 75% (Normal)</span>
            <span class="badge bg-warning">75-99% (High)</span>
            <span class="badge bg-danger">100%+ (Overloaded)</span>
        </div>
        <div class="relative">
            {% set load_ranges = {
                'Underloaded (0-2 courses)': {'count': 0, 'color': 'green'},
                'Optimal (3-4 courses)': {'count': 0, 'color': 'blue'},
                'High (5+ courses)': {'count': 0, 'color': 'red'}
            } %}

            {% for data in teaching_data.values() %}
                {% if data.current_courses < 3 %}
                    {% set _ = load_ranges['Underloaded (0-2 courses)'].update({'count': load_ranges['Underloaded (0-2 courses)']['count'] + 1}) %}
                {% elif data.current_courses <= 4 %}
                    {% set _ = load_ranges['Optimal (3-4 courses)'].update({'count': load_ranges['Optimal (3-4 courses)']['count'] + 1}) %}
                {% else %}
                    {% set _ = load_ranges['High (5+ courses)'].update({'count': load_ranges['High (5+ courses)']['count'] + 1}) %}
                {% endif %}
            {% endfor %}

            {% set total = teaching_data|length %}
            
            <div class="flex h-4 mb-4">
                {% for range, data in load_ranges.items() %}
                    {% if data.count > 0 %}
                        <div class="bg-{{ data.color }}-500" style="width: {{ (data.count / total * 100)|round }}%"
                             title="{{ range }}: {{ data.count }} professors ({{ (data.count / total * 100)|round }}%)">
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="flex flex-wrap gap-4">
                {% for range, data in load_ranges.items() %}
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-{{ data.color }}-500 mr-2"></div>
                        <span class="text-sm text-gray-600">{{ range }}: {{ data.count }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %} 