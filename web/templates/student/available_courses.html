{% extends "shared/base.html" %}

{% block title %}Available Courses{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="container">
        <!-- Header -->
        <div class="mb-4">
            <h1 class="h2 fw-bold text-dark">Available Courses</h1>
            <p class="mt-2 text-muted">Browse and register for courses for the upcoming semester.</p>
        </div>

        <!-- Filters -->
        <div class="bg-white shadow-sm rounded mb-4">
            <div class="p-4">
                <form action="{{ url_for('students.available_courses') }}" method="GET" class="row g-3 align-items-center">
                    <!-- Search -->
                    <div class="col-md-4">
                        <label for="search" class="visually-hidden">Search courses</label>
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0"><svg class="icon-md text-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></span>
                            <input type="text" name="search" id="search" value="{{ request.args.get('search', '') }}" class="form-control border-start-0" placeholder="Search by course code or name">
                        </div>
                    </div>
                    <!-- Semester Filter -->
                    <div class="col-md-3">
                        <label for="semester" class="visually-hidden">Semester</label>
                        <select id="semester" name="semester" class="form-select">
                            <option value="">All Semesters</option>
                            {% for semester in semesters %}
                            <option value="{{ semester.value }}" {% if request.args.get('semester') == semester.value %}selected{% endif %}>{{ semester.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Course Level Filter -->
                    <div class="col-md-3">
                        <label for="level" class="visually-hidden">Course Level</label>
                        <select id="level" name="level" class="form-select">
                            <option value="">All Levels</option>
                            {% for level in course_levels %}
                            <option value="{{ level.value }}" {% if request.args.get('level') == level.value %}selected{% endif %}>{{ level.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Submit Button -->
                    <div class="col-md-2 text-end">
                        <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Course List -->
        <div class="bg-white shadow-sm rounded overflow-hidden">
            {% if schedules %}
            <ul class="list-group list-group-flush">
                {% for schedule in schedules %}
                <li class="list-group-item p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="flex-grow-1">
                                    <h3 class="fs-6 fw-medium text-dark mb-1">{{ schedule.course.course_code }} - {{ schedule.course.course_name }}</h3>
                                    <div class="row g-2 mb-2">
                                        <div class="col-auto d-flex align-items-center small text-muted">
                                            <svg class="icon-md text-muted me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" /></svg>
                                            {% if schedule.professors and schedule.professors|length > 0 %}Prof. {{ schedule.professors[0].last_name }}{% else %}No professor assigned{% endif %}
                                        </div>
                                        <div class="col-auto d-flex align-items-center small text-muted">
                                            <svg class="icon-md text-muted me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                                            {{ schedule.meeting_days }} {{ schedule.start_time.strftime('%H:%M') }} - {{ schedule.end_time.strftime('%H:%M') }}
                                        </div>
                                        <div class="col-auto d-flex align-items-center small text-muted">
                                            <svg class="icon-md text-muted me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0h8v12H6V4z" clip-rule="evenodd" /></svg>
                                            Room {{ schedule.room_number }}
                                        </div>
                                        <div class="col-auto d-flex align-items-center small text-muted">
                                            <svg class="icon-md text-muted me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/></svg>
                                            {% set enrolled_count = schedule.enrollments | selectattr('status', 'equalto', 'enrolled') | list | length %}
                                            {{ enrolled_count }}/{{ schedule.course.max_capacity }} enrolled
                                        </div>
                                        <div class="col-auto d-flex align-items-center small text-muted">
                                            <svg class="icon-md text-muted me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M12 8c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2zm-2 8c-4.41 0-8-1.79-8-4V6c0-2.21 3.59-4 8-4s8 1.79 8 4v6c0 2.21-3.59 4-8 4z"/>
                                            </svg>
                                            {{ schedule.course.credits }} credits
                                        </div>
                                    </div>
                                </div>
                                <div class="ms-3 flex-shrink-0">
                                    {% if enrolled_count >= schedule.course.max_capacity %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger">Full</span>
                                    {% else %}
                                    <form action="{{ url_for('students.register_course') }}" method="POST">
                                        {{ form.hidden_tag() }}
                                        <input type="hidden" name="schedule_id" value="{{ schedule.schedule_id }}">
                                        <button type="submit" class="btn btn-primary btn-sm">Register</button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mt-2">
                                <p class="small text-muted mb-0">{{ schedule.course.description }}</p>
                                {% set prereqs = schedule.course.prerequisites.all() if schedule.course.prerequisites and schedule.course.prerequisites.all is not none else schedule.course.prerequisites %}
                                {% if prereqs and prereqs|length > 0 %}
                                    <p class="small text-warning mb-0">Prerequisites: {{ prereqs|map(attribute='course_code')|join(', ') }}</p>
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary me-2">{{ schedule.semester }}</span>
                                <span class="badge bg-success bg-opacity-10 text-success me-2">{{ schedule.academic_year }}</span>
                                <span class="badge bg-purple bg-opacity-10 text-purple">{{ schedule.course.credits }} credits</span>
                            </div>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="text-center py-5">
                <svg class="mx-auto icon-md text-muted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                <h3 class="mt-2 small fw-medium text-dark">No courses found</h3>
                <p class="mt-1 small text-muted">Try adjusting your search or filter criteria.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="fixed bottom-0 right-0 m-8">
    {% for category, message in messages %}
    <div class="bg-{{ 'green' if category == 'success' else 'red' }}-100 border-l-4 border-{{ 'green' if category == 'success' else 'red' }}-500 text-{{ 'green' if category == 'success' else 'red' }}-700 p-4 mb-4 rounded shadow-lg">
        <div class="flex">
            <div class="flex-shrink-0">
                {% if category == 'success' %}
                <svg class="h-[20px] w-[20px] text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                {% else %}
                <svg class="h-[20px] w-[20px] text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                {% endif %}
            </div>
            <div class="ml-3">
                <p class="text-sm">{{ message }}</p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}
{% endblock %}